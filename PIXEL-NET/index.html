<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PIXEL-NET Arcade</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <!-- bump v to force CSS refresh -->
  <link rel="stylesheet" href="style.css?v=20" />
</head>
<body>

  <!-- Top-right initials badge -->
  <button id="px-player-badge" class="px-badge" type="button" aria-label="Player initials">???</button>

  <!-- Initials Modal (fixed: real backdrop + clicks + typing work) -->
  <div id="px-modal" class="px-modal" aria-hidden="true">
    <div id="px-modal-backdrop" class="px-modal__backdrop"></div>

    <section class="px-modal__card" role="dialog" aria-modal="true" aria-labelledby="px-modal-title">
      <div class="px-modal__top">
        <div id="px-modal-title" class="px-modal__title">WELCOME TO PIXEL-NET</div>
        <button id="px-modal-close" class="px-modal__close" type="button" aria-label="Close">×</button>
      </div>

      <div class="px-modal__sub">Enter your initials to tag scores across games.</div>

      <div class="px-modal__row">
        <input id="px-initials-input"
               class="px-modal__input"
               type="text"
               inputmode="text"
               autocomplete="off"
               autocapitalize="characters"
               spellcheck="false"
               maxlength="3"
               placeholder="_ _ _" />
        <button id="px-initials-save" class="px-modal__btn" type="button">SAVE</button>
      </div>

      <div id="px-initials-error" class="px-modal__error" aria-live="polite"></div>
      <div class="px-modal__hint">Press <b>Enter</b> to save. Click your initials (top-right) anytime to change.</div>
    </section>
  </div>

  <header class="site-header">
    <div class="brand">
      <div class="brand-mark">PX</div>
      <div class="brand-text">
        <div class="brand-title">PIXEL-NET</div>
        <div class="brand-subtitle">Online Arcade Network</div>
      </div>
    </div>

    <nav class="nav">
      <a class="nav-link" href="#featured-game">Featured</a>
      <a class="nav-link" href="#game-library">Library</a>
      <a class="nav-link" href="#leaderboards">Top Dogs</a>
    </nav>
  </header>

  <main class="wrap">

    <section id="featured-game" class="section">
      <div class="featured-card">
        <div class="featured-media">
          <img id="featuredThumb" src="assets/millipede_thumb.png" alt="Featured Game">
          <div class="featured-glow"></div>
          <div class="scanlines"></div>
        </div>

        <div class="featured-info">
          <span class="badge">Game of the Week</span>
          <h2 id="featuredTitle">Loading…</h2>
          <p class="muted">Play games. Set records. Become a Top Dog.</p>
          <button id="featuredPlay" class="btn">Play Featured</button>
        </div>
      </div>
    </section>

    <section id="game-library" class="section">
      <div class="section-head px-headrow">
        <div>
          <h3>Arcade Floor</h3>
          <p class="muted">Pick a cabinet. Click to play.</p>
        </div>

        <!-- fixed: search bar styled like the site, not default input -->
        <div class="px-searchwrap" role="search">
          <span class="px-searchicon" aria-hidden="true">⌕</span>
          <input id="px-search" class="px-search" type="search" placeholder="Search games…" autocomplete="off" />
        </div>
      </div>

      <div id="arcadeGrid" class="game-grid"></div>
      <div id="px-empty" class="px-empty muted" style="display:none;">No games match your search.</div>
    </section>

    <section id="leaderboards" class="section">
      <div class="section-head">
        <h3>Top Dogs</h3>
        <p class="muted">Players holding #1 scores the longest.</p>
      </div>

      <!-- leaderboard.js fills this -->
      <div id="topdogs-panel" class="px-board">
        <div class="muted">Loading…</div>
      </div>
    </section>

  </main>

  <footer class="footer wrap">
    <div class="muted">CREATED BY TYLER WAGGONER WITH THE USE OF AI</div>
    <div class="muted">PIXEL-NET • GitHub Pages</div>
  </footer>

  <!-- ===================== INITIALS LOGIC (FIXED) ===================== -->
  <script>
    (function () {
      const LS_KEY = "px_player_initials";
      const SS_KEY = "playerInitials";

      const badge = document.getElementById("px-player-badge");
      const modal = document.getElementById("px-modal");
      const backdrop = document.getElementById("px-modal-backdrop");
      const closeBtn = document.getElementById("px-modal-close");
      const input = document.getElementById("px-initials-input");
      const saveBtn = document.getElementById("px-initials-save");
      const err = document.getElementById("px-initials-error");

      function normalize(v) {
        return String(v || "")
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 3);
      }

      function getInitials() {
        return localStorage.getItem(LS_KEY) || sessionStorage.getItem(SS_KEY) || "";
      }

      function setInitials(v) {
        localStorage.setItem(LS_KEY, v);
        sessionStorage.setItem(SS_KEY, v);
      }

      function setError(msg) {
        err.textContent = msg || "";
      }

      function renderBadge() {
        const v = getInitials();
        badge.textContent = v || "???";
      }

      function openModal() {
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
        setError("");

        // prefill if exists
        input.value = getInitials();
        // focus reliably
        setTimeout(() => { input.focus(); input.select(); }, 0);
      }

      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        setError("");
      }

      function saveInitials() {
        const v = normalize(input.value);
        if (!v) {
          setError("Enter 1–3 letters or numbers.");
          input.focus();
          return;
        }
        setInitials(v);
        renderBadge();
        closeModal();
      }

      // Events
      badge.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      backdrop.addEventListener("click", closeModal);
      saveBtn.addEventListener("click", saveInitials);

      input.addEventListener("input", () => {
        const before = input.value;
        const after = normalize(before);
        if (before !== after) input.value = after;
        setError("");
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") saveInitials();
        if (e.key === "Escape") closeModal();
      });

      // Init on load
      window.addEventListener("DOMContentLoaded", () => {
        renderBadge();

        // Only auto-open if no initials yet (but user can close now)
        if (!getInitials()) openModal();
      });
    })();
  </script>

  <!-- ===================== GAMES LOADER + SEARCH ===================== -->
  <script>
    function normalizeGame(g) {
      const name  = g.name ?? g.title ?? g.game ?? g.id ?? "UNTITLED";
      const thumb = g.thumb ?? g.image ?? g.thumbnail ?? "";
      const path  = g.path ?? g.url ?? g.href ?? "";
      return { name, thumb, path };
    }

    function renderGrid(games) {
      const grid = document.getElementById("arcadeGrid");
      const empty = document.getElementById("px-empty");
      grid.innerHTML = "";

      if (!games.length) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      games.forEach(game => {
        const card = document.createElement("div");
        card.className = "game-card";

        const img = document.createElement("img");
        img.src = game.thumb || "assets/millipede_thumb.png";
        img.alt = game.name;

        const title = document.createElement("h4");
        title.textContent = game.name;

        card.appendChild(img);
        card.appendChild(title);

        card.addEventListener("click", () => {
          if (!game.path) return alert("Missing path for: " + game.name);
          window.location.href = game.path;
        });

        grid.appendChild(card);
      });
    }

    async function loadGames() {
      const res = await fetch("./games.json", { cache: "no-store" });
      const raw = await res.json();
      const allGames = raw.map(normalizeGame);

      // Featured = first
      const featured = allGames[0];
      if (featured) {
        document.getElementById("featuredThumb").src = featured.thumb || "assets/millipede_thumb.png";
        document.getElementById("featuredTitle").textContent = featured.name;
        document.getElementById("featuredPlay").onclick = () => window.location.href = featured.path;
      }

      renderGrid(allGames);

      const search = document.getElementById("px-search");
      search.addEventListener("input", () => {
        const q = (search.value || "").trim().toLowerCase();
        if (!q) return renderGrid(allGames);
        renderGrid(allGames.filter(g => (g.name || "").toLowerCase().includes(q)));
      });
    }

    loadGames().catch(err => {
      console.error(err);
      alert("Loader error — check console.");
    });
  </script>

  <!-- ===================== LEADERBOARD ===================== -->
  <script src="js/leaderboard.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof renderTopDogs === "function") {
        renderTopDogs("topdogs-panel");
        setInterval(() => renderTopDogs("topdogs-panel"), 30000);
      } else {
        console.warn("leaderboard.js not loaded or renderTopDogs missing");
      }
    });
  </script>

</body>
</html>
