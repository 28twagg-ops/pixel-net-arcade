<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>PIXEL-NET • Creek Crosser</title>

  <!-- Canon wrapper layout (same structure/behavior as Millipede wrapper):
       - Left HOW TO PLAY panel
       - Center autoscaled stage
       - Right LEADERBOARD panel
       - Keeps game aspect ratio via fitStage() (no distortion)
  -->
  <style>
    :root{
      --bg0:#070912;
      --bg1:#0b0f25;
      --panel:#0b1226cc;
      --panel2:#0b1226aa;
      --stroke:rgba(255,255,255,.10);
      --text:#e9ecff;
      --muted:#a7b0d8;
      --shadow:0 18px 60px rgba(0,0,0,.45);

      /* Game accent (Creek Crosser = chick yellow) */
      --game-accent:#f1c40f;
      --game-accent2:#e67e22;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(241,196,15,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(230,126,34,.14), transparent 60%),
        radial-gradient(900px 700px at 65% 80%, rgba(80,120,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .topbar{
      position:fixed; left:0; right:0; top:0;
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      z-index:50;
      pointer-events:none;
    }
    .topbar .left,
    .topbar .right{display:flex; gap:12px; align-items:center; pointer-events:auto;}

    .pill{
      border:1px solid var(--stroke);
      background:rgba(10,12,26,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius:14px;
      padding:10px 14px;
      box-shadow:0 12px 36px rgba(0,0,0,.35);
      display:inline-flex; align-items:center; gap:10px;
      color:var(--text);
      text-decoration:none;
      font-weight:800;
      letter-spacing:.08em;
      font-size:12px;
      text-transform:uppercase;
    }

    .app{
      position:fixed;
      inset:64px 0 0 0;
      display:grid;
      grid-template-columns: 320px minmax(0, 1fr) 320px;
      gap:18px;
      padding:18px;
      height:calc(100% - 64px);
    }

    .panel{
      border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
      overflow:auto;
    }

    .panel h3{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--game-accent);
      text-shadow:0 0 16px rgba(241,196,15,.25);
    }

    .howto p{margin:10px 0; color:var(--muted); line-height:1.35}
    .howto b{color:var(--text)}

    .stage-wrap{
      border:1px solid var(--stroke);
      background:var(--panel2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .stage-title{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      padding:6px 6px 10px;
    }
    .stage-title h2{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--text);
    }
    .stage-title small{color:var(--muted)}

    .stage-viewport{
      position:relative;
      flex:1;
      min-height:0;
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      background:rgba(0,0,0,.28);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* The element whose size we control (keeps aspect ratio). */
    .stage-inner{
      position:relative;
      width:100px;
      height:100px;
      border-radius:16px;
      overflow:hidden;
      background:#000;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }

    #gameFrame{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#000;
    }

    .leaderboard ol{margin:10px 0 0; padding-left:18px; color:var(--muted)}
    .leaderboard li{margin:8px 0}
    .lb-row{display:flex; justify-content:space-between; gap:10px}
    .lb-score{color:var(--text); font-weight:800}

    @media (max-width: 1100px){
      body{overflow:auto}
      .app{
        position:relative;
        inset:auto;
        height:auto;
        grid-template-columns: 1fr;
      }
      .panel, .stage-wrap{min-height:unset}
      .topbar{position:sticky}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="left">
      <a class="pill" href="../../index.html">EXIT</a>
    </div>
    <div class="right">
      <div class="pill" id="px-badge">???</div>
    </div>
  </div>

  <div class="app">
    <aside class="panel howto">
      <h3>HOW TO PLAY</h3>
      <p><b>Move:</b> Arrow Keys / WASD</p>
      <p><b>Goal:</b> Reach the 5 nests at the top.</p>
      <p><b>Avoid:</b> Cars on the road and falling in the creek.</p>
      <p><b>Tip:</b> On water rows, you must be on a log/turtle/platform.</p>
      <p><b>Mobile:</b> The on‑screen D‑pad is shown automatically on touch devices.</p>
    </aside>

    <main class="stage-wrap">
      <div class="stage-title">
        <h2>CREEK CROSSER</h2>
        <small>Leaderboard refreshes automatically.</small>
      </div>
      <div class="stage-viewport" id="stageViewport">
        <div class="stage-inner" id="stageInner">
          <iframe id="gameFrame" src="./game.html" title="Creek Crosser" allow="fullscreen" loading="eager"></iframe>
        </div>
      </div>
    </main>

    <aside class="panel leaderboard">
      <h3>LEADERBOARD</h3>
      <div style="color:var(--muted)">Top 10</div>
      <ol id="lbList">
        <li>Loading…</li>
      </ol>
    </aside>
  </div>

  <script src="../../js/engine.js"></script>
  <script>
    // Creek Crosser wrapper version
    const WRAPPER_VERSION = "1.3";

    // Game's *native* logical size in grid units (keeps aspect ratio).
    // Creek Crosser draws a 13x13 grid canvas plus a UI bar below.
    // We budget 2 extra grid rows for the UI bar so the stage doesn't crop it.
    const GRID_COLS = 13;
    const GRID_ROWS = 15;

    // Show initials in the badge (engine.js already normalizes & stores).
    (function syncBadge(){
      try {
        const s = sessionStorage.getItem('playerInitials') || localStorage.getItem('px_player_initials') || '???';
        document.getElementById('px-badge').textContent = (s||'???').toString().toUpperCase().slice(0,3);
      } catch(_){}
    })();

    // --- Autoscale stage (same idea as Millipede): keep aspect ratio, no distortion.
    function fitStage(){
      const vp = document.getElementById('stageViewport');
      const inner = document.getElementById('stageInner');
      if(!vp || !inner) return;

      const pad = 18; // breathing room inside viewport
      const maxW = Math.max(0, vp.clientWidth - pad*2);
      const maxH = Math.max(0, vp.clientHeight - pad*2);

      const aspect = GRID_COLS / GRID_ROWS;
      let w = maxW;
      let h = w / aspect;
      if(h > maxH){
        h = maxH;
        w = h * aspect;
      }

      inner.style.width  = Math.floor(w) + 'px';
      inner.style.height = Math.floor(h) + 'px';
    }

    window.addEventListener('resize', fitStage);
    window.addEventListener('orientationchange', fitStage);
    setTimeout(fitStage, 0);

    // --- Leaderboard (uses the shared PixelNet engine)
    async function refreshLB(){
      const list = document.getElementById('lbList');
      if(!list || !window.PixelNet) return;

      const rows = await PixelNet.getLeaderboard('creek-crosser');
      list.innerHTML = '';

      if(!rows || rows.length === 0){
        const li = document.createElement('li');
        li.textContent = 'No scores yet.';
        list.appendChild(li);
        return;
      }

      rows.slice(0,10).forEach((r)=>{
        const li = document.createElement('li');
        const wrap = document.createElement('div');
        wrap.className = 'lb-row';
        const left = document.createElement('span');
        left.textContent = (r.initials || '???').toString().toUpperCase();
        const right = document.createElement('span');
        right.className = 'lb-score';
        right.textContent = String(r.score ?? 0);
        wrap.appendChild(left);
        wrap.appendChild(right);
        li.appendChild(wrap);
        list.appendChild(li);
      });
    }

    refreshLB();
    setInterval(refreshLB, 4000);

    // Debug hint in console
    console.log('[CreekCrosser wrapper]', { version: WRAPPER_VERSION, GRID_COLS, GRID_ROWS });
  </script>
</body>
</html>
