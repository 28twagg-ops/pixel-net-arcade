<!-- FORCE_PAGES_REDEPLOY -->
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>MILLIPEDE CHAOS</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{--text:#e9ecff;--muted:#a7b0d6;--card1:rgba(15,19,36,.72);--card2:rgba(10,12,26,.55);--stroke:rgba(255,255,255,.10);--shadow:0 14px 40px rgba(0,0,0,.35)}
*{box-sizing:border-box}
html,body{height:100%}

/* ✅ allow scrolling + normal touch on the page */
body{
  margin:0;
  min-height:100dvh;
  overflow:auto;
  display:flex;
  flex-direction:column;
  padding:10px 0 10px;
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,0,122,.14), transparent 60%),
    radial-gradient(900px 500px at 85% 20%, rgba(0,255,247,.12), transparent 55%),
    linear-gradient(180deg,#050611 0%,#060716 100%);
  color-scheme:dark;
  touch-action:auto;
  overscroll-behavior:auto;
}

.topbar{
  width:min(1300px,94vw);
  margin:0 auto 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex:0 0 auto;
}
.btn,.badge{
  height:38px;
  padding:0 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(10,12,26,.72);
  color:var(--text);
  font:700 13px/1 "Orbitron",system-ui,sans-serif;
  letter-spacing:.10em;
  cursor:pointer;
}
.badge{min-width:54px;display:inline-grid;place-items:center}
.layout{
  width:min(1300px,94vw);
  margin:0 auto;
  display:grid;
  grid-template-columns: minmax(260px, 320px) minmax(520px, 1fr) minmax(260px, 320px);
  gap:14px;
  align-items:stretch;
  flex:1 1 auto;
  min-height:0;
}
@media (max-width:1100px){.layout{grid-template-columns: minmax(260px, 320px) minmax(520px, 1fr) minmax(260px, 320px);gap:10px}}
.panel{
  background:linear-gradient(180deg,var(--card1),var(--card2));
  border:1px solid var(--stroke);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:14px;
  min-height:0;
  overflow:auto;
}
.title{font-family:"Orbitron",system-ui,sans-serif;letter-spacing:.10em;margin:0 0 10px;font-size:14px}
.muted{color:var(--muted)}
.hint{color:var(--muted);font-size:12px;margin-top:10px}

main.panel{display:flex;flex-direction:column;min-height:0}

/* ✅ lock touch + overscroll ONLY inside the game box */
.gamebox{
  position:relative;
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  min-height:0;
  touch-action:none;
  overscroll-behavior:contain;
  flex:1 1 auto;
}

#root{width:100%;height:100%;min-height:0}
#root > div{height:100%}
#root canvas{display:block}

.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.lb-col{list-style:none;padding:0;margin:0}
.lb-item{display:flex;justify-content:space-between;gap:10px;padding:6px 8px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18);margin-bottom:8px;font-family:"Orbitron",system-ui,sans-serif;letter-spacing:.06em;font-size:12px}
.lb-rank{opacity:.85;min-width:22px}.lb-score{font-weight:800}
.lb-meta{color:var(--muted);font-size:11px;margin-top:10px}

@media (max-width:1100px){
  .panel{max-height:18vh}
  main.panel{max-height:none;flex:1 1 auto}
  main.panel .gamebox{flex:1 1 auto}
}

/* VERSION BANNER */
#pn-version-banner{
  position:fixed;
  left:0; right:0; top:0;
  z-index:999999;
  font:12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding:6px 10px;
  background:rgba(0,0,0,0.78);
  color:#e9ecff;
  border-bottom:1px solid rgba(255,255,255,0.15);
  pointer-events:none;
}
body{ padding-top:28px; }


/* V1.13 fixes */
.layout > *{min-width:0;}
.panel{min-height:0;}
.panel.leaderboard{overflow:hidden;}
.panel.leaderboard .lb-grid{height:100%; overflow:auto;}
/* keep game contained */
.game-shell{position:relative; overflow:hidden;}
#root{width:100%; height:100%;}
/* hide in-game DDT/POISON legend strip */
#root *{box-sizing:border-box;}
/* try to hide legend row if present */
#root .legend, #root [class*="legend"]{display:none !important;}
/* initials modal (wrapper) */

/* V1.13 fixes */
#px-play-again{
  position:absolute;
  inset:0;
  display:none; /* shown only on Game Over */
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,.55);
  z-index: 50;
}
#px-play-again .inner{
  background: rgba(10,12,26,.86);
  border:1px solid rgba(255,255,255,.14);
  border-radius: 16px;
  padding: 18px 22px;
  text-align:center;
}
#px-play-again h3{margin:0 0 10px;font-family:"Orbitron",system-ui,sans-serif;letter-spacing:.10em}
#px-play-again button{
  height:42px;
  padding:0 16px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(10,12,26,.72);
  color: var(--text);
  font: 800 13px/1 "Orbitron",system-ui,sans-serif;
  letter-spacing: .10em;
  cursor:pointer;
}

.game-stage{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 1;
}
.game-stage-inner{
  position:relative;
  overflow:hidden;
  border-radius: 12px;
}
.game-stage-inner #root{width:100%;height:100%;min-height:0;}
.game-stage-inner #root > div{height:100%}
.game-stage-inner #root canvas{width:100% !important; height:100% !important; display:block;}

/* Leaderboard: true 2-column list, no clipping */
.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.lb-item{min-width:0}
.lb-item span:nth-child(2){flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-score{white-space:nowrap}

.px-init-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.px-init-modal.hidden {
  display: none;
}

.px-init-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
}

.px-init-card {
  position: relative;
  z-index: 1;
  width: 320px;
  padding: 18px 18px 20px;
  border-radius: 16px;
  background: linear-gradient(
    180deg,
    rgba(15, 19, 36, 0.95),
    rgba(10, 12, 26, 0.95)
  );
  border: 1px solid rgba(0, 255, 247, 0.35);
  box-shadow: 0 0 24px rgba(0, 255, 247, 0.15);
  text-align: center;
}

.px-init-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: "Orbitron", system-ui, sans-serif;
  letter-spacing: 0.10em;
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 10px;
}

#px-init-close {
  width: 34px;
  height: 34px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(10,12,26,.72);
  color: var(--text);
  cursor: pointer;
}

#px-init-input {
  width: 100%;
  height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  color: var(--text);
  font: 700 16px/1 "Orbitron", system-ui, sans-serif;
  letter-spacing: .20em;
  text-align: center;
  outline: none;
  margin: 8px 0 10px;
}

#px-init-save {
  width: 100%;
  height: 42px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(10,12,26,.72);
  color: var(--text);
  font: 800 13px/1 "Orbitron", system-ui, sans-serif;
  letter-spacing: .10em;
  cursor: pointer;
}

#px-init-save:hover { filter: brightness(1.08); }

.px-init-hint {
  margin-top: 10px;
  font-size: 12px;
  color: var(--muted);
}

</style>
<!-- React build -->
<script crossorigin="" src="./assets/index-BTthQfIO.js" type="module"></script>
</head>
<body>
<!-- PATCH_VERSION:MILLIPede_WRAPPER_scrollfix_v2026-02-02_1625cst -->
<div id="pn-version-banner">PIXEL-NET · Millipede wrapper · <strong>V1.13</strong></div>
<section id="px-init-modal" class="px-init-modal hidden" aria-hidden="true">
  <div class="px-init-backdrop"></div>
  <div class="px-init-card" role="dialog" aria-modal="true" aria-label="Enter Initials">
    <div class="px-init-header">
      <span>ENTER INITIALS</span>
      <button id="px-init-close" type="button" aria-label="Close">×</button>
    </div>
    <input id="px-init-input" type="text" maxlength="3" placeholder="_ _ _" autocomplete="off"
      autocapitalize="characters" spellcheck="false" />
    <button id="px-init-save" type="button">SAVE</button>
    <div class="px-init-hint">Press Enter to save</div>
  </div>
</section>

<div class="topbar">
<button class="btn" id="px-exit">EXIT</button>
<div class="badge" id="px-badge" title="Click to change initials">???</div>
</div>
<div class="layout">
<aside class="panel">
<h3 class="title">HOW TO PLAY</h3>
<div class="muted">
<p><b>Move:</b> Arrow Keys / WASD</p>
<p><b>Shoot:</b> Space</p>
<p><b>Goal:</b> Clear the swarm, survive, score high.</p>
</div>
<div class="hint">Initials are set on the homepage. Click the badge (top-right) to change.</div>
<div class="hint"><b>Game Over:</b> score auto-saves. Press <b>Enter</b> to restart.</div>
</aside>
<main class="panel">
<h3 class="title">MILLIPEDE CHAOS</h3>
<div class="gamebox">
<div class="game-stage" id="pn-stage"><div class="game-stage-inner" id="pn-stage-inner"><div id="root"></div></div></div>
<div id="px-play-again">
<div class="inner">
<h3>GAME OVER</h3>
<button id="px-play-again-btn">PLAY AGAIN</button>
</div>
</div>
</div>
<div class="muted">Leaderboard refreshes automatically.</div>
</main>
<aside class="panel">
<h3 class="title">LEADERBOARD</h3>
<div class="muted">Top 10</div>
<div class="lb-grid">
<ol class="lb-col" id="lb-left"></ol>
<ol class="lb-col" id="lb-right"></ol>
</div>
<div class="lb-meta" id="lb-status">Loading…</div>
</aside>
</div>
<script src="../../js/engine.js"></script>
<script>
    (function(){
      const SLUGS = ["millipede-react","millipede","millipede-chaos"];

      function norm(v){ return String(v||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,3) || "???"; }
      const initials = norm(localStorage.getItem("px_player_initials") || sessionStorage.getItem("playerInitials") || "???");

      // Keep storages in sync for PixelNet + the React build (various keys observed)
      sessionStorage.setItem("playerInitials", initials);
      try{
        localStorage.setItem("p", initials);
        localStorage.setItem("u", initials);
        localStorage.setItem("n", initials);
        localStorage.setItem("nm", initials);
      }catch(_){}

      if(window.PixelNet && PixelNet.init) PixelNet.init();

      const badge = document.getElementById("px-badge");
      badge.textContent = initials || "???";
      if(window.PixelNet && PixelNet.uiInit) PixelNet.uiInit();
      document.getElementById("px-exit").onclick = () => location.href = "../../index.html";
      // --- V1.13: aspect-fit stage (20x32) to prevent horizontal stretch ---
      const stageInner = document.getElementById("pn-stage-inner");
      const gamebox = document.querySelector(".gamebox");
      function fitStage(){
        if(!stageInner || !gamebox) return;
        const W = gamebox.clientWidth;
        const H = gamebox.clientHeight;
        const ratio = 20/32; // width/height
        let w, h;
        if(W/H > ratio){
          h = H;
          w = Math.floor(H * ratio);
        }else{
          w = W;
          h = Math.floor(W / ratio);
        }
        stageInner.style.width = w + "px";
        stageInner.style.height = h + "px";
      }
      fitStage();
      window.addEventListener("resize", fitStage);


      // ---- Block duplicate /api/score submissions (even if React game tries) ----
      // We allow ONE real POST per page-load for this slug.
      let sentOnce = false;

      function shouldBlockScorePost(url, bodyText){
        if(!url || typeof url !== "string") return false;
        if(url.indexOf("/api/score") === -1) return false;
        try{
          const obj = bodyText ? JSON.parse(bodyText) : null;
          const slug = obj && (obj.game_slug || obj.gameSlug);
          if(slug && String(slug) !== SLUG) return false;
        }catch(_){
          // If we can't parse, still treat as score post and gate it.
        }
        if(sentOnce) return true;
        sentOnce = true;
        return false;
      }

      const _fetch = window.fetch ? window.fetch.bind(window) : null;
      if(_fetch){
        window.fetch = async function(input, init){
          const url = (typeof input === "string") ? input : (input && input.url) || "";
          const bodyText = init && init.body ? String(init.body) : "";
          if(shouldBlockScorePost(url, bodyText)){
            console.warn("[Millipede wrapper] blocked duplicate /api/score");
            return new Response("", {status: 204});
          }
          return _fetch(input, init);
        };
      }

      // XHR guard (some bundles still use it)
      const _open = XMLHttpRequest.prototype.open;
      const _send = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.open = function(method, url){
        this.__px_url = url;
        this.__px_method = method;
        return _open.apply(this, arguments);
      };
      XMLHttpRequest.prototype.send = function(body){
        const url = this.__px_url || "";
        const bodyText = body ? String(body) : "";
        if(shouldBlockScorePost(url, bodyText)){
          console.warn("[Millipede wrapper] blocked duplicate XHR /api/score");
          try{ this.abort(); }catch(_){}
          return;
        }
        return _send.apply(this, arguments);
      };

      // ---- LEADERBOARD RENDER ----
      async function renderLeaderboard(){
        const status = document.getElementById("lb-status");
        const L = document.getElementById("lb-left");
        const R = document.getElementById("lb-right");
        L.innerHTML=""; R.innerHTML="";
        try{
          let rows=[];
      for (const slug of SLUGS){
        try{ rows = await PixelNet.getLeaderboard(slug); }catch(e){ rows=[]; }
        if (Array.isArray(rows) && rows.length) break;
      }
          const top = (rows || []).slice(0,10);
          if(!top.length){ status.textContent="No scores yet."; return; }
          top.forEach((row,i)=>{
            const ini = norm(row.initials || row.name || "???");
            const sc = Number(row.score ?? row.points ?? row.value ?? 0) || 0;
            const li=document.createElement("li");
            li.className="lb-item";
            li.innerHTML=`<span class="lb-rank">${i+1}.</span><span>${ini}</span><span class="lb-score">${sc}</span>`;
            (i<5?L:R).appendChild(li);
          });
          status.textContent="Auto-refreshing…";
        }catch(e){
          console.error("[Millipede wrapper] leaderboard fetch failed:", e);
          status.textContent="Failed to load leaderboard (backend sleeping?).";
        }
      }
      renderLeaderboard();
      setInterval(renderLeaderboard, 6000);

      // ---- Auto-save on GAME OVER, remove SAVE UI, Enter to restart ----
      let gameOverSeen = false;
      let savedThisDeath = false;
      let lastScoreSaved = -1;

      function readScoreNow(){
        // Overlay shows "SCORE: 1,344"
        const txt = document.body.innerText || "";
        const m = txt.match(/SCORE:\s*([0-9][0-9,]*)/i);
        if(m && m[1]) return parseInt(m[1].replace(/,/g,""),10) || 0;

        const overIdx = txt.toUpperCase().indexOf("GAME OVER");
        const slice = overIdx>=0 ? txt.slice(overIdx, overIdx+220) : txt;
        const m2 = slice.match(/([0-9][0-9,]{2,})/);
        return m2 ? (parseInt(m2[1].replace(/,/g,""),10) || 0) : 0;
      }

      function hideSaveUI(){
        const root = document.getElementById("root");
        const killRe = /(ENTER\s+YOUR?\s*INITIALS|TYPE\s+YOUR?\s*INITIALS|ENTER\s+INITIALS|YOUR\s+INITIALS)/i;

        for (const b of Array.from(document.querySelectorAll("button"))){
          const t = ((b.textContent||"").trim()).toUpperCase();
          if(t==="SAVE" || t==="ENTER INITIALS" || t==="SUBMIT" || t==="OK"){
            b.style.display="none";
            b.disabled=true;
          }
          if(killRe.test(t)){
            b.style.display="none";
            b.disabled=true;
          }
        }

        for (const inp of Array.from(document.querySelectorAll("input"))){
          const ml = inp.getAttribute("maxlength");
          const ph = (inp.getAttribute("placeholder")||"").trim();
          if(ml==="3" || ph.includes("_")){
            inp.style.display="none";
            inp.disabled=true;
          }
        }

        if(root){
          for (const el of Array.from(root.querySelectorAll("*"))){
            if(el.childElementCount>0) continue;
            const txt = (el.textContent||"").trim();
            if(!txt || txt.length>80) continue;
            if(killRe.test(txt)){
              el.textContent = "";
              el.style.display="none";
              el.setAttribute("aria-hidden","true");
            }
          }
        }
      }

      async function autoSaveIfGameOver(){
        const buttons = Array.from(document.querySelectorAll("#root button, button"));
        const hasSaveBtn = buttons.some(b => (b.textContent||"").trim().toUpperCase()==="SAVE");
        const hasEnterInitials = Array.from(document.querySelectorAll("#root *")).some(el => (el.textContent||"").trim().toUpperCase()==="ENTER INITIALS");
        const hasGameOverInRoot = Array.from(document.querySelectorAll("#root *")).some(el => (el.textContent||"").trim().toUpperCase()==="GAME OVER");

        const isOver = hasSaveBtn || hasEnterInitials || hasGameOverInRoot;
        if(!isOver) return;

        gameOverSeen = true;
        hideSaveUI();

        const score = readScoreNow();
        if(savedThisDeath) return;
        if(score === lastScoreSaved) return;

        savedThisDeath = true;
        lastScoreSaved = score;

        try{
          console.log("[Millipede wrapper] auto-saving on death", {slug: SLUG, initials, score});
          if(window.PixelNet && PixelNet.submitScore){
            await PixelNet.submitScore(SLUG, score);
          }
          setTimeout(renderLeaderboard, 600);

          const pa = document.getElementById("px-play-again");
          if(pa) pa.style.display = "flex";
        }catch(err){
          console.error("[Millipede wrapper] auto-save failed:", err);
          const pa = document.getElementById("px-play-again");
          if(pa) pa.style.display = "flex";
        }
      }

      const obs = new MutationObserver(()=>autoSaveIfGameOver());
      obs.observe(document.body, {subtree:true, childList:true, characterData:true});
      autoSaveIfGameOver();

      const paBtn = document.querySelector('#px-play-again button');
      if(paBtn){ paBtn.onclick = ()=>location.reload(); }

      window.addEventListener("keydown", (e)=>{
        if((e.code==="Enter" || e.key==="Enter") && gameOverSeen){
          e.preventDefault();
          location.reload();
        }
      }, {capture:true});
    })();

</script>

</body>
</html>