<!-- PIXEL-NET Millipede Wrapper -->
<!-- Version: V3.5 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NEON TRAIL RIDERS</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800&display=swap" rel="stylesheet"/>

<style>
/* ========================================================
   PIXEL-NET · Millipede Wrapper · V2.0
   Single consolidated stylesheet — no hotfix layers.
   ======================================================== */

/* --- Design Tokens --- */
:root {
  --text:        #e9ecff;
  --muted:       #a7b0d6;
  --card-top:    rgba(15, 19, 36, .72);
  --card-bot:    rgba(10, 12, 26, .55);
  --stroke:      rgba(255, 255, 255, .10);
  --shadow:      0 14px 40px rgba(0, 0, 0, .35);
  --accent-cyan: rgba(0, 255, 247, .35);
  --glow-cyan:   rgba(0, 255, 247, .15);
  --font-ui:     system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  --font-arcade: "Orbitron", var(--font-ui);
  --banner-h:    28px;   /* version banner height */
  --topbar-h:    38px;
  --gap:         14px;

  /* ── Millipede game-theme palette ── */
  /* Deep mossy greens for panel fills */
  --game-card-top:  rgba(22, 14, 10, .88);   /* dark forest */
  --game-card-bot:  rgba(10, 6, 4, .74);   /* deeper moss */
  /* Warm mushroom-cap accent (the red-orange caps in-game) */
  --game-accent:    rgba(255, 180, 70, .55);  /* burnt mushroom */
  --game-glow:      rgba(255, 180, 70, .20);  /* subtle warm glow */
  /* Leaf-green stroke */
  --game-stroke:    rgba(255, 70, 150, .16); /* soft green edge */
  /* Leaderboard item tint — very faint green wash */
  --game-item-bg:   rgba(255, 140, 90, .16);
  --game-item-stroke: rgba(255, 180, 70, .14);
}

/* --- Reset --- */
*, *::before, *::after { box-sizing: border-box; }

/* --- Root / Body --- */
html, body { height: 100%; margin: 0; }
body {
  min-height: 100dvh;
  overflow: auto;                          /* page-level scroll allowed */
  display: flex;
  flex-direction: column;
  padding: var(--banner-h) 0 10px;         /* top pad = banner height */
  color: var(--text);
  font-family: var(--font-ui);
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,0,122,.14), transparent 60%),
    radial-gradient(900px 500px at 85% 20%, rgba(0,255,247,.12), transparent 55%),
    linear-gradient(180deg, #050611 0%, #060716 100%);
  color-scheme: dark;
  touch-action: auto;
  overscroll-behavior: auto;
}

/* --------------------------------------------------------
   VERSION BANNER  (fixed top strip)
   -------------------------------------------------------- */
#pn-version-banner {
  position: fixed;
  inset: 0 0 auto 0;                      /* top-left-right */
  height: var(--banner-h);
  z-index: 999999;
  display: flex;
  align-items: center;
  padding: 0 10px;
  font: 12px/1.2 var(--font-ui);
  background: rgba(0, 0, 0, .78);
  color: var(--text);
  border-bottom: 1px solid var(--stroke);
  pointer-events: none;
}

/* --------------------------------------------------------
   TOP BAR  (Exit left · Badge right)
   -------------------------------------------------------- */
.topbar {
  width: min(1300px, 94vw);
  margin: 0 auto 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex: 0 0 auto;
}
.btn, .badge {
  height: var(--topbar-h);
  padding: 0 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(10,12,26,.72);
  color: var(--text);
  font: 700 13px/1 var(--font-arcade);
  letter-spacing: .10em;
  cursor: pointer;
  transition: filter .15s;
}
.btn:hover, .badge:hover { filter: brightness(1.12); }
.badge {
  min-width: 54px;
  display: inline-grid;
  place-items: center;
}

/* --------------------------------------------------------
   THREE-COLUMN LAYOUT  (desktop)
   -------------------------------------------------------- */
.layout {
  width: min(1300px, 94vw);
  margin: 0 auto;
  display: grid;
  grid-template-columns: minmax(220px, 280px)  /* How To Play */
                         minmax(360px, 1fr)     /* Game        */
                         minmax(220px, 280px);  /* Leaderboard */
  gap: var(--gap);
  align-items: stretch;
  flex: 1 1 auto;
  min-height: 0;
}

/* --------------------------------------------------------
   PANELS  (shared chrome)
   -------------------------------------------------------- */
.panel {
  background: linear-gradient(180deg, var(--card-top), var(--card-bot));
  border: 1px solid var(--stroke);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 14px;
  min-height: 0;
  overflow: auto;
}
.panel.leaderboard { overflow: hidden; }

/* --------------------------------------------------------
   GAME-THEMED PANELS  (How To Play + Leaderboard)
   Deep moss greens + warm mushroom-cap accents
   -------------------------------------------------------- */
aside.panel {
  background: linear-gradient(180deg, var(--game-card-top), var(--game-card-bot));
  border-color: var(--game-stroke);
  box-shadow: 0 14px 40px rgba(0,0,0,.35), 0 0 18px var(--game-glow);
}
aside.panel .title {
  color: #7fdf8a;                          /* leaf-green heading */
  text-shadow: 0 0 8px rgba(80, 200, 100, .25);
}
aside.panel .muted,
aside.panel .hint  { color: #8aac8f; }     /* muted moss-green body text */
aside.panel .hint b { color: #b8e6bf; }    /* slightly brighter emphasis */

/* Leaderboard items: green-washed cards with subtle warm top border on #1 */
.lb-item {
  background: var(--game-item-bg);
  border-color: var(--game-item-stroke);
}
.lb-item:first-child {
  border-top: 2px solid var(--game-accent);  /* mushroom-cap gold-line on rank 1 */
}
.lb-rank  { color: #7fdf8a; }
.lb-score { color: #f0c87a; }              /* warm amber scores */
.lb-meta  { color: #6a8a70; }

.title {
  font-family: var(--font-arcade);
  letter-spacing: .10em;
  margin: 0 0 10px;
  font-size: 14px;
}
.muted { color: var(--muted); }
.hint  { color: var(--muted); font-size: 12px; margin-top: 10px; }

/* --------------------------------------------------------
   GAME PANEL  (center column)
   -------------------------------------------------------- */
main.panel {
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* Outer container — fills the panel, clips nothing except overflow */
.gamebox {
  position: relative;
  flex: 1 1 auto;
  min-height: 0;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.28);
  touch-action: none;                      /* block scroll ONLY here */
  overscroll-behavior: contain;
}

/* Centering stage — fills gamebox, centers the inner aspect-locked shell */
.game-stage {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
}

/* Aspect-locked shell — width + height set by JS (fitStage) */
.game-stage-inner {
  position: relative;
  overflow: hidden;
  border-radius: 12px;
  background: rgba(0,0,0,.22);
}
.game-stage-inner #root            { width: 100%; height: 100%; min-height: 0; }
.game-stage-inner #root > div      { height: 100%; }
.game-stage-inner #root canvas     { width: 100% !important; height: 100% !important; display: block; }

/* --------------------------------------------------------
   LEADERBOARD  (right column)
   -------------------------------------------------------- */
.lb-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
  height: 100%;
  overflow: auto;
}
.lb-col { list-style: none; padding: 0; margin: 0; }
.lb-item {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 8px;
  margin-bottom: 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.18);
  font-family: var(--font-arcade);
  letter-spacing: .06em;
  font-size: 12px;
  min-width: 0;
}
.lb-item .lb-name {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.lb-rank  { opacity: .85; min-width: 22px; }
.lb-score { font-weight: 800; white-space: nowrap; }
.lb-meta  { color: var(--muted); font-size: 11px; margin-top: 10px; }

/* --------------------------------------------------------
   INITIALS MODAL  (compact banner-style, Enter to save)
   -------------------------------------------------------- */
.px-init-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.px-init-modal.hidden { display: none; }

.px-init-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(4px);
}

.px-init-card {
  position: relative;
  z-index: 1;
  width: 300px;
  padding: 16px 18px 14px;
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(15,19,36,.95), rgba(10,12,26,.95));
  border: 1px solid var(--accent-cyan);
  box-shadow: 0 0 24px var(--glow-cyan);
  text-align: center;
}

/* Header row: label left, close right */
.px-init-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--font-arcade);
  letter-spacing: .10em;
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 10px;
}
#px-init-close {
  width: 30px;
  height: 30px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(10,12,26,.72);
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: filter .15s;
}
#px-init-close:hover { filter: brightness(1.15); }

/* 3-char input — the only interactive element */
#px-init-input {
  width: 100%;
  height: 42px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  color: var(--text);
  font: 700 18px/1 var(--font-arcade);
  letter-spacing: .24em;
  text-align: center;
  outline: none;
  margin: 4px 0 6px;
  transition: border-color .2s;
}
#px-init-input:focus { border-color: var(--accent-cyan); }

/* Subtle "Press Enter to save" hint — no big SAVE button */
.px-init-hint {
  font-size: 11px;
  color: var(--muted);
  letter-spacing: .04em;
}


/* SAVE button: hidden on desktop (Enter-to-save UX), shown on mobile */
#px-init-save {
  display: none;
}
/* --------------------------------------------------------
   MOBILE LAYOUT  (single column + tabs)
   -------------------------------------------------------- */
.mobile-tabs        { display: none; }                /* hidden on desktop */
.m-panel              { display: none; }                /* hidden on desktop, shown by tab JS on mobile */
.mobile-tabs button { /* styled below in the media query */ }

@media (max-width: 1000px) {
  /* --- hide desktop grid, show mobile stack --- */
  .layout { display: none; }

  .topbar { width: 96vw; margin-bottom: 6px; }

  /* Tab bar */
  .mobile-tabs {
    display: flex;
    width: 96vw;
    margin: 0 auto 6px;
    gap: 4px;
  }
  .mobile-tabs button {
    flex: 1;
    height: 34px;
    border-radius: 10px;
    border: 1px solid var(--stroke);
    background: rgba(10,12,26,.55);
    color: var(--muted);
    font: 700 11px/1 var(--font-arcade);
    letter-spacing: .08em;
    cursor: pointer;
    transition: background .18s, color .18s;
  }
  .mobile-tabs button.active {
    background: rgba(0,255,247,.15);
    border-color: var(--accent-cyan);
    color: var(--text);
  }

  /* Mobile panels — stacked, each shown/hidden by JS */
  .m-panel {
    display: block;                          /* re-enable; .hidden toggles per-tab */
    width: 96vw;
    margin: 0 auto 8px;
    border-radius: 16px;
    background: linear-gradient(180deg, var(--card-top), var(--card-bot));
    border: 1px solid var(--stroke);
    box-shadow: var(--shadow);
    padding: 14px;
  }
  .m-panel.hidden { display: none; }

  /* Game-themed colors on mobile How To Play + Leaderboard */
  #m-howto, #m-lb {
    background: linear-gradient(180deg, var(--game-card-top), var(--game-card-bot));
    border-color: var(--game-stroke);
    box-shadow: 0 14px 40px rgba(0,0,0,.35), 0 0 18px var(--game-glow);
  }
  #m-howto .title, #m-lb .title {
    color: #7fdf8a;
    text-shadow: 0 0 8px rgba(80, 200, 100, .25);
  }
  #m-howto .muted, #m-howto .hint,
  #m-lb .muted    { color: #8aac8f; }
  #m-howto .hint b { color: #b8e6bf; }
  #m-lb .lb-item  { background: var(--game-item-bg); border-color: var(--game-item-stroke); }
  #m-lb .lb-item:first-child { border-top: 2px solid var(--game-accent); }
  #m-lb .lb-rank  { color: #7fdf8a; }
  #m-lb .lb-score { color: #f0c87a; }
  #m-lb .lb-meta  { color: #6a8a70; }

  /* Game panel: let the gamebox fill remaining viewport height */
  #m-game .gamebox {
    width: 100%;
    /* height = viewport − banner − topbar − tabs − panel-pad − some breathing room */
    height: calc(100dvh - var(--banner-h) - var(--topbar-h) - 34px - 28px - 60px);
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid var(--stroke);
    background: rgba(0,0,0,.28);
    touch-action: none;
    overscroll-behavior: contain;
  }
  /* Reuse the same stage classes; fitStage JS targets #pn-stage-inner */
  #m-game .game-stage        { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index:1; }
  #m-game .game-stage-inner  { position: relative; overflow: hidden; border-radius: 12px;
  background: rgba(0,0,0,.22); }
  #m-game .game-stage-inner #root            { width: 100%; height: 100%; min-height: 0; }
  #m-game .game-stage-inner #root > div      { height: 100%; }
  #m-game .game-stage-inner #root canvas     { width: 100% !important; height: 100% !important; display: block; }

  /* ── Mobile modal: matches the screenshot exactly ── */
  .px-init-card {
    width: 88vw;
    max-width: 340px;
    padding: 22px 20px 24px;
  }
  .px-init-header {
    font-size: 14px;
    margin-bottom: 14px;
  }
  #px-init-close {
    width: 34px;
    height: 34px;
    border-radius: 12px;
    font-size: 20px;
  }
  #px-init-input {
    height: 48px;
    font-size: 20px;
    margin: 6px 0 12px;
  }
  /* Show the SAVE button on mobile */
  #px-init-save {
    display: block;
    width: 100%;
    height: 44px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,12,26,.72);
    color: var(--text);
    font: 800 13px/1 var(--font-arcade);
    letter-spacing: .10em;
    cursor: pointer;
    margin-bottom: 4px;
    transition: filter .15s;
  }
  #px-init-save:hover { filter: brightness(1.12); }
  .px-init-hint {
    font-size: 13px;
    margin-top: 2px;
  }
}

</style>
</head>
<body>

<!-- ============================================================
     VERSION BANNER
     ============================================================ -->
<div id="pn-version-banner">
  PIXEL-NET · Millipede · <strong>V2.4</strong>
</div>

<!-- ============================================================
     INITIALS MODAL  (opened by badge click, not navigation)
     ============================================================ -->
<section id="px-init-modal" class="px-init-modal hidden" aria-hidden="true">
  <div class="px-init-backdrop"></div>
  <div class="px-init-card" role="dialog" aria-modal="true" aria-label="Enter Initials">
    <div class="px-init-header">
      <span>ENTER INITIALS</span>
      <button id="px-init-close" type="button" aria-label="Close">×</button>
    </div>
    <input id="px-init-input" type="text" maxlength="3" placeholder="_ _ _"
           autocomplete="off" autocapitalize="characters" spellcheck="false"/>
    <button id="px-init-save" type="button">SAVE</button>
    <div class="px-init-hint">Press Enter to save</div>
  </div>
</section>

<!-- ============================================================
     TOP BAR
     ============================================================ -->
<div class="topbar">
  <button class="btn" id="px-exit">EXIT</button>
  <div  class="badge" id="px-badge" title="Click to change initials">???</div>
</div>

<!-- ============================================================
     MOBILE TAB BAR  (visible only ≤ 768px)
     ============================================================ -->
<div class="mobile-tabs" id="m-tabs">
  <button class="active" data-tab="game">GAME</button>
  <button            data-tab="howto">HOW TO PLAY</button>
  <button            data-tab="lb">LEADERBOARD</button>
</div>

<!-- ============================================================
     DESKTOP: THREE-COLUMN GRID
     ============================================================ -->
<div class="layout">

  <!-- LEFT: How To Play -->
  <aside class="panel">
    <h3 class="title">HOW TO PLAY</h3>
    <div class="muted">
      
      <p><b>Steer:</b> Arrow Keys / WASD</p>
      <p><b>Goal:</b> Ride the trail, avoid collisions, keep your streak.</p>
      <p><b>Tip:</b> Tight turns = big points.</p>
    </div>
    <div class="hint">
      Initials are set on the homepage. Click the badge (top-right) to change them here.
    </div>
    <div class="hint">
      <b>Game Over:</b> your score auto-saves. Press <b>Enter</b> to restart.
    </div>
  </aside>

  <!-- CENTER: Game -->
  <main class="panel">
    <h3 class="title">NEON TRAIL RIDERS</h3>
    <div class="gamebox">
      <div class="game-stage" id="pn-stage">
        <div class="game-stage-inner" id="pn-stage-inner">
          <iframe id="pn-iframe" title="NEON TRAIL RIDERS" src="./game.html" style="border:0; width:100%; height:100%; display:block; background:transparent;"></iframe>
        </div>
      </div>
    </div>
    <div class="muted" style="font-size:11px; margin-top:6px;">Leaderboard refreshes automatically.</div>
  </main>

  <!-- RIGHT: Leaderboard -->
  <aside class="panel leaderboard">
    <h3 class="title">LEADERBOARD</h3>
    <div class="muted">Top 10</div>
    <div class="lb-grid">
      <ol class="lb-col" id="lb-left"></ol>
      <ol class="lb-col" id="lb-right"></ol>
    </div>
    <div class="lb-meta" id="lb-status">Loading…</div>
  </aside>
</div>

<!-- ============================================================
     MOBILE PANELS  (shown/hidden by tab JS; ≤ 768px only)
     They duplicate the content above so the desktop grid stays
     untouched and the React #root lives in one place.
     ============================================================ -->
<div id="m-howto" class="m-panel hidden">
  <h3 class="title">HOW TO PLAY</h3>
  <div class="muted">
    
      <p><b>Steer:</b> Arrow Keys / WASD</p>
      <p><b>Goal:</b> Ride the trail, avoid collisions, keep your streak.</p>
      <p><b>Tip:</b> Tight turns = big points.</p>
  </div>
  <div class="hint">Click the badge (top-right) to change initials.</div>
  <div class="hint"><b>Game Over:</b> score auto-saves. Press <b>Enter</b> to restart.</div>
</div>

<div id="m-game" class="m-panel hidden">
  <div class="gamebox">
    <!-- On mobile, fitStage targets this inner shell via #pn-stage-inner.
         The game iframe is moved between desktop and mobile containers. -->
    <div class="game-stage">
      <div class="game-stage-inner" id="pn-stage-inner-mobile">
        <!-- #root lives in the desktop panel; mobile just shows the same viewport.
             See note in script: on mobile we move #root here. -->
      </div>
    </div>
  </div>
</div>

<div id="m-lb" class="m-panel hidden">
  <h3 class="title">LEADERBOARD</h3>
  <div class="muted">Top 10</div>
  <div class="lb-grid">
    <ol class="lb-col" id="m-lb-left"></ol>
    <ol class="lb-col" id="m-lb-right"></ol>
  </div>
  <div class="lb-meta" id="m-lb-status">Loading…</div>
</div>

<!-- ============================================================
     ENGINE  (PixelNet SDK — provides getLeaderboard / submitScore)
     ============================================================ -->
<script src="../../js/engine.js"></script>

<!-- ============================================================
     WRAPPER LOGIC  (V2.0 — single consolidated IIFE)
     ============================================================ -->
<script>
(function () {
  "use strict";

  // --------------------------------------------------------
  // ============================================================
  // CONFIG  ←  change these per game, leave everything else alone
  // ============================================================
  var GAME_CONFIG = {
    // Slugs: leaderboard fetch tries each in order; first one is used for score submission.
    slugs:        ["neon-trail-riders", "neontrailriders"],


    // If false, wrapper lets the game fill the panel (no letterboxing).
    lockAspect:   false,
    // Native grid dimensions (columns × rows).
    // fitStage() uses width/height to lock the aspect ratio.
    //   Millipede  →  20 × 32
    //   Example 4:3 game → e.g. 40 × 30
    //   Example 16:9 game → e.g. 16 × 9
    gridCols:     20,
    gridRows:     32
  };
  // Derived — don't edit these.
  var SLUGS = GAME_CONFIG.slugs;
  var SLUG  = SLUGS[0];
  var ACTIVE_SLUG = SLUG;   // updated when leaderboard fetch finds a live slug
  var GAME_ASPECT = GAME_CONFIG.gridCols / GAME_CONFIG.gridRows;  // width / height

  // --------------------------------------------------------
  // HELPERS
  // --------------------------------------------------------
  /** Normalise initials: uppercase, alphanumeric only, max 3 chars. */
  function norm(v) {
    return String(v || "").toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 3) || "???";
  }

  // --------------------------------------------------------
  // INITIALS BOOTSTRAP  (sync localStorage ↔ sessionStorage)
  // --------------------------------------------------------
  var initials = norm(
    localStorage.getItem("px_player_initials") ||
    sessionStorage.getItem("playerInitials")   ||
    "???"
  );

  // Write to every key the React bundle might read.
  function syncInitials(val) {
    val = norm(val);
    try { localStorage.setItem("px_player_initials", val); } catch(_){}
    try { sessionStorage.setItem("playerInitials",   val); } catch(_){}
    try { localStorage.setItem("p",  val); } catch(_){}
    try { localStorage.setItem("u",  val); } catch(_){}
    try { localStorage.setItem("n",  val); } catch(_){}
    try { localStorage.setItem("nm", val); } catch(_){}
  }
  syncInitials(initials);

  // Boot PixelNet SDK if available.
  if (window.PixelNet && PixelNet.init)   PixelNet.init();
  if (window.PixelNet && PixelNet.uiInit) PixelNet.uiInit();

  // --------------------------------------------------------
  // TOP-BAR WIRING
  // --------------------------------------------------------
  var badge = document.getElementById("px-badge");
  badge.textContent = initials;

  // Cross-tab / homepage sync: if the homepage updates px_player_initials, reflect it here.
  window.addEventListener("storage", function (e) {
    if (!e) return;
    if (e.key === "px_player_initials" && e.newValue) {
      var v = norm(e.newValue);
      if (v && v !== initials) {
        initials = v;
        syncInitials(v);
        badge.textContent = v;
      }
    }
  });
  document.getElementById("px-exit").onclick = function () {
    location.href = "../../index.html";
  };

  // --------------------------------------------------------
  // INITIALS MODAL  (badge click → open, Enter / close → save & sync)
  // --------------------------------------------------------
  var modal   = document.getElementById("px-init-modal");
  var input   = document.getElementById("px-init-input");
  var closBtn = document.getElementById("px-init-close");

  function openModal() {
    input.value = initials !== "???" ? initials : "";
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    input.focus();
  }
  function closeModal() {
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
  }
  function saveInitials() {
    var v = norm(input.value);
    if (v && v !== "???") {
      initials = v;
      syncInitials(v);
      badge.textContent = v;
    }
    closeModal();
  }

  badge.addEventListener("click", openModal);
  closBtn.addEventListener("click", saveInitials);   // close = save

  input.addEventListener("keydown", function (e) {
    if (e.key === "Enter") { e.preventDefault(); saveInitials(); }
    if (e.key === "Escape") { e.preventDefault(); closeModal(); }
  });

  // Click backdrop → save & close
  modal.querySelector(".px-init-backdrop").addEventListener("click", saveInitials);

  // SAVE button (visible on mobile) — same action as close/Enter
  var saveBtn = document.getElementById("px-init-save");
  if (saveBtn) saveBtn.addEventListener("click", saveInitials);

  
  // --------------------------------------------------------
  // IFRAME TWEAKS  (embed mode: no white, no desktop joysticks)
  // --------------------------------------------------------
  function applyIframeTweaks() {
    var frame = document.getElementById("pn-iframe");
    if (!frame) return;
    var doc = null;
    try { doc = frame.contentDocument; } catch(_) { doc = null; }
    if (!doc) return;

    // Inject once
    if (!doc.getElementById("px-embed-style")) {
      var style = doc.createElement("style");
      style.id = "px-embed-style";
      style.textContent = `
        html, body { margin:0 !important; padding:0 !important; height:100% !important; background: #050611 !important; overflow:hidden !important; }
        canvas { display:block; }
        /* Hide virtual sticks on desktop */
        @media (min-width: 1001px) {
          .joystick, .joysticks, .touch-joystick, .touch-controls,
          #joystick, #joystick-left, #joystick-right, #left-joystick, #right-joystick,
          [class*="joystick"], [id*="joystick"] { display:none !important; opacity:0 !important; pointer-events:none !important; }
        }
      `;
      doc.head.appendChild(style);
    }
  }

  // --------------------------------------------------------
  // ASPECT-FIT  (uses GAME_CONFIG.gridCols / gridRows)
  // --------------------------------------------------------
  var stageInner = document.getElementById("pn-stage-inner");
  var gamebox    = document.querySelector(".gamebox");   // desktop gamebox

  function fitStage() {
    // If this game is freeform/fullscreen, let it fill the panel.
    if (GAME_CONFIG.lockAspect === false) {
      var boxF = (window.innerWidth <= 1000) ? document.querySelector("#m-game .gamebox") : document.querySelector(".gamebox");
      var innerF = (window.innerWidth <= 1000) ? document.getElementById("pn-stage-inner-mobile") : document.getElementById("pn-stage-inner");
      if (innerF && boxF) {
        innerF.style.width = boxF.clientWidth + "px";
        innerF.style.height = boxF.clientHeight + "px";
      }
      return;
    }

    // On mobile the gamebox reference may differ; grab the visible one.
    var box = gamebox;
    var inner = stageInner;

    if (window.innerWidth <= 1000) {
      box   = document.querySelector("#m-game .gamebox");
      inner = document.getElementById("pn-stage-inner-mobile");
    }
    if (!inner || !box) return;

    var W     = box.clientWidth;
    var H     = box.clientHeight;
    var ratio = GAME_ASPECT;             // set in GAME_CONFIG above
    var w, h;

    if (W / H > ratio) {
      // Container is wider than the game → fit to height
      h = H;
      w = Math.floor(H * ratio);
    } else {
      // Container is taller → fit to width
      w = W;
      h = Math.floor(W / ratio);
    }

    inner.style.width  = w + "px";
    inner.style.height = h + "px";
  }

  applyIframeTweaks();
  fitStage();
  window.addEventListener("resize", function(){ applyIframeTweaks(); fitStage(); });

  // --------------------------------------------------------
  // DUPLICATE-SCORE GUARD
  // Allows exactly ONE real /api/score POST per page-load per slug,
  // blocking any extra attempts the React bundle might make.
  // --------------------------------------------------------
  var sentOnce = false;

  function shouldBlockScorePost(url, bodyText) {
    if (!url || typeof url !== "string") return false;
    if (url.indexOf("/api/score") === -1)  return false;

    // If we can parse a slug and it's NOT ours, let it through.
    try {
      var obj  = bodyText ? JSON.parse(bodyText) : null;
      var slug = obj && (obj.game_slug || obj.gameSlug);
      if (slug && SLUGS.indexOf(String(slug)) === -1) return false;
    } catch(_) { /* unparseable → treat as ours */ }

    if (sentOnce) return true;   // already sent → block
    sentOnce = true;
    return false;                // first time  → allow
  }

  // Patch fetch
  var _fetch = window.fetch ? window.fetch.bind(window) : null;
  if (_fetch) {
    window.fetch = function (input, init) {
      var url      = (typeof input === "string") ? input : (input && input.url) || "";
      var bodyText = init && init.body ? String(init.body) : "";
      if (shouldBlockScorePost(url, bodyText)) {
        console.warn("[Millipede V2] blocked duplicate /api/score (fetch)");
        return Promise.resolve(new Response("", { status: 204 }));
      }
      return _fetch(input, init);
    };
  }

  // Patch XHR
  var _open = XMLHttpRequest.prototype.open;
  var _send = XMLHttpRequest.prototype.send;
  XMLHttpRequest.prototype.open = function (method, url) {
    this.__px_url    = url;
    this.__px_method = method;
    return _open.apply(this, arguments);
  };
  XMLHttpRequest.prototype.send = function (body) {
    var url      = this.__px_url || "";
    var bodyText = body ? String(body) : "";
    if (shouldBlockScorePost(url, bodyText)) {
      console.warn("[Millipede V2] blocked duplicate /api/score (XHR)");
      try { this.abort(); } catch(_) {}
      return;
    }
    return _send.apply(this, arguments);
  };

  // --------------------------------------------------------
  // LEADERBOARD  (fetch + render into both desktop & mobile lists)
  // --------------------------------------------------------
  async function renderLeaderboard() {
    var status  = document.getElementById("lb-status");
    var mStatus = document.getElementById("m-lb-status");
    var L       = document.getElementById("lb-left");
    var R       = document.getElementById("lb-right");
    var mL      = document.getElementById("m-lb-left");
    var mR      = document.getElementById("m-lb-right");

    L.innerHTML = ""; R.innerHTML = "";
    mL.innerHTML = ""; mR.innerHTML = "";

    if (!(window.PixelNet && PixelNet.getLeaderboard)) {
      var msg0 = "Leaderboard unavailable."; 
      status.textContent  = msg0;
      mStatus.textContent = msg0;
      return;
    }

    try {
      var rows = [];
      // Try each slug until we get results.
      for (var i = 0; i < SLUGS.length; i++) {
        try { rows = await PixelNet.getLeaderboard(SLUGS[i]); } catch(_) { rows = []; }
        if (Array.isArray(rows) && rows.length) { ACTIVE_SLUG = SLUGS[i]; break; }
      }

      var top = (rows || []).slice(0, 10);
      if (!top.length) {
        status.textContent  = "No scores yet.";
        mStatus.textContent = "No scores yet.";
        return;
      }

      top.forEach(function (row, idx) {
        var ini = norm(row.initials || row.name || "???");
        var sc  = Number(row.score != null ? row.score : (row.points != null ? row.points : (row.value != null ? row.value : 0))) || 0;

        // Build <li> for desktop
        var li = document.createElement("li");
        li.className = "lb-item";
        li.innerHTML =
          '<span class="lb-rank">' + (idx + 1) + '.</span>' +
          '<span class="lb-name">' + ini + '</span>' +
          '<span class="lb-score">' + sc + '</span>';

        // Desktop: 1-5 left, 6-10 right
        (idx < 5 ? L : R).appendChild(li);

        // Mobile copy
        var mli = li.cloneNode(true);
        (idx < 5 ? mL : mR).appendChild(mli);
      });

      status.textContent  = "Auto-refreshing…";
      mStatus.textContent = "Auto-refreshing…";

    } catch (e) {
      console.error("[Millipede V2] leaderboard fetch failed:", e);
      var msg = "Failed to load (backend sleeping?).";
      status.textContent  = msg;
      mStatus.textContent = msg;
    }
  }

  renderLeaderboard();
  setInterval(renderLeaderboard, 6000);

  // --------------------------------------------------------
  // GAME-OVER DETECTION + AUTO-SAVE
  // We poll periodically instead of a MutationObserver to keep things
  // simple and stable.  6-second LB refresh already proves the interval
  // approach works; we just need a faster cadence for the GAME OVER moment.
  // --------------------------------------------------------
  var gameOverSeen    = false;
  var isGameOverNow   = false;
  var savedThisDeath  = false;
  var lastScoreSaved  = -1;

  /** Read the visible score out of the page text (React renders it). */
  function readScoreNow() {
    var frame = document.getElementById("pn-iframe");
    var txt = "";
    try { txt = (frame && frame.contentDocument && frame.contentDocument.body && frame.contentDocument.body.innerText) ? frame.contentDocument.body.innerText : ""; } catch(_) { txt = ""; }
// Primary: "SCORE: 1,234" anywhere on page
    var m = txt.match(/SCORE:\s*([0-9][0-9,]*)/i);
    if (m && m[1]) return parseInt(m[1].replace(/,/g, ""), 10) || 0;

    // Fallback: first large number near "GAME OVER"
    var overIdx = txt.toUpperCase().indexOf("GAME OVER");
    var slice   = overIdx >= 0 ? txt.slice(overIdx, overIdx + 220) : txt;
    var m2      = slice.match(/([0-9][0-9,]{2,})/);
    return m2 ? (parseInt(m2[1].replace(/,/g, ""), 10) || 0) : 0;
  }

  /** Hide any "SAVE" / "ENTER INITIALS" UI the React bundle renders on death. */
  function hideSaveUI() {
    var killRe = /(ENTER\s+YOUR?\s*INITIALS|TYPE\s+YOUR?\s*INITIALS|ENTER\s+INITIALS|YOUR\s+INITIALS)/i;

    // Kill matching buttons
    Array.from((frameD||document).querySelectorAll("button")).forEach(function (b) {
      if (b.id === "px-init-save") return;   // leave OUR modal SAVE button alone
      var t = (b.textContent || "").trim().toUpperCase();
      if (t === "SAVE" || t === "ENTER INITIALS" || t === "SUBMIT" || t === "OK" || killRe.test(t)) {
        b.style.display = "none";
        b.disabled = true;
      }
    });

    // Kill 3-char inputs (initials entry)
    Array.from((frameD||document).querySelectorAll("input")).forEach(function (inp) {
      if (inp.id === "px-init-input") return;   // leave OUR modal input alone
      var ml = inp.getAttribute("maxlength");
      var ph = (inp.getAttribute("placeholder") || "").trim();
      if (ml === "3" || ph.includes("_")) {
        inp.style.display = "none";
        inp.disabled = true;
      }
    });

    // Kill bare text nodes that match the prompt
    var root = frameD ? frameD.body : null;
    if (root) {
      Array.from(root.querySelectorAll("*")).forEach(function (el) {
        if (el.childElementCount > 0) return;
        var txt = (el.textContent || "").trim();
        if (!txt || txt.length > 80) return;
        if (killRe.test(txt)) {
          el.textContent = "";
          el.style.display = "none";
          el.setAttribute("aria-hidden", "true");
        }
      });
    }
  }

  /** Core check — called on every poll tick. */
  async function checkGameOver() {
    var rootButtons = Array.from(document.querySelectorAll("#root button"));
    var hasSaveBtn = rootButtons.some(function (b) {
      return (b.textContent || "").trim().toUpperCase() === "SAVE";
    });
    var rootEls = Array.from(frameD.querySelectorAll("*"));
    var hasInitialsPrompt = rootEls.some(function (el) {
      return (el.textContent || "").trim().toUpperCase() === "ENTER INITIALS";
    });
    var hasGameOver = rootEls.some(function (el) {
      return (el.textContent || "").trim().toUpperCase() === "GAME OVER";
    });

    isGameOverNow = (hasSaveBtn || hasInitialsPrompt || hasGameOver);

    if (!isGameOverNow) return;   // not dead yet

    // --- We are in GAME OVER state ---
    gameOverSeen = true;
    hideSaveUI();

    if (savedThisDeath) return;   // already submitted this death

    var score = readScoreNow();
    if (score === lastScoreSaved) return;   // same score, no-op

    savedThisDeath  = true;
    lastScoreSaved  = score;

    try {
      console.log("[Millipede V2] auto-saving score", { slug: ACTIVE_SLUG, initials: initials, score: score });
      if (window.PixelNet && PixelNet.submitScore) {
        await PixelNet.submitScore(ACTIVE_SLUG, score);
      }
      // Refresh leaderboard after a short delay so the backend has time.
      setTimeout(renderLeaderboard, 700);
    } catch (err) {
      console.error("[Millipede V2] auto-save failed:", err);
    }
  }

  // Poll every 800 ms.  Lightweight and reliable.
  setInterval(checkGameOver, 800);
  checkGameOver();   // run once immediately

  // --------------------------------------------------------
  // ENTER-TO-RESTART  (only after game over seen)
  // --------------------------------------------------------
  document.addEventListener("keydown", function (e) {
    if ((e.code === "Enter" || e.key === "Enter") && gameOverSeen) {
      // If our initials modal is open, let the modal handle it.
      if (!modal.classList.contains("hidden")) return;
      e.preventDefault();
      // Reset death-tracking flags so the next death submits again.
      gameOverSeen   = false;
      isGameOverNow  = false;
      savedThisDeath = false;
      sentOnce       = false;
      ACTIVE_SLUG   = SLUG;
      location.reload();
    }
  }, { capture: true });

  // --------------------------------------------------------
  // TAP/CLICK-TO-RESTART  (mobile-friendly)
  // After GAME OVER, tapping/clicking the game area reloads the page
  // so the user can immediately start again (no keyboard required).
  // --------------------------------------------------------
  function restartNowFromPointer(e) {
    if (!gameOverSeen || !isGameOverNow) return;
    if (!modal.classList.contains("hidden")) return; // don't hijack modal taps
    // Don't treat dragging/swiping as a restart.
    if (e && e.type === "pointerup" && e.pointerType === "touch") {
      // no-op; pointerup is fine
    }
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    gameOverSeen   = false;
    isGameOverNow  = false;
    savedThisDeath = false;
    sentOnce       = false;
    location.reload();
  }

  // Bind to both desktop + mobile game containers (even if one is hidden).
  Array.from(document.querySelectorAll(".gamebox")).forEach(function (box) {
    // Use pointerup to avoid blocking gameplay taps while alive.
    box.addEventListener("pointerup", restartNowFromPointer, { passive: false });
    box.addEventListener("click", restartNowFromPointer, { passive: false });
    box.addEventListener("touchend", restartNowFromPointer, { passive: false });
  });


  // --------------------------------------------------------
  // MOBILE TAB SWITCHING
  // --------------------------------------------------------
  var mobileRoot = document.getElementById("pn-iframe");
  var tabButtons = document.querySelectorAll("#m-tabs button");
  var mGame      = document.getElementById("m-game");
  var mHowTo     = document.getElementById("m-howto");
  var mLb        = document.getElementById("m-lb");

  function showMobileTab(tab) {
    // Deactivate all
    tabButtons.forEach(function (b) { b.classList.remove("active"); });
    mGame.classList.add("hidden");
    mHowTo.classList.add("hidden");
    mLb.classList.add("hidden");

    // Activate chosen
    document.querySelector('#m-tabs button[data-tab="' + tab + '"]').classList.add("active");

    if (tab === "game") {
      mGame.classList.remove("hidden");
      // Move #root into the mobile gamebox if not already there.
      var mInner = document.getElementById("pn-stage-inner-mobile");
      if (mInner && mRoot && mInner !== mRoot.parentNode) {
        mInner.appendChild(mRoot);
      }
      fitStage();
    } else if (tab === "howto") {
      mHowTo.classList.remove("hidden");
    } else if (tab === "lb") {
      mLb.classList.remove("hidden");
    }
  }

  // Cache the #root element for potential re-parenting on mobile.
  var mRoot = document.getElementById("pn-iframe");

  tabButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      showMobileTab(btn.getAttribute("data-tab"));
    });
  });

  // On mobile, default to GAME tab and move #root into mobile container.
  if (window.innerWidth <= 1000) {
    showMobileTab("game");
  }

  // Ensure iframe tweaks applied after load
  var _f = document.getElementById("pn-iframe");
  if (_f) _f.addEventListener("load", applyIframeTweaks);

  // Also re-check on resize (desktop ↔ mobile transition)
  window.addEventListener("resize", function () {
    fitStage();
    if (window.innerWidth <= 1000) {
      showMobileTab("game");
    } else {
      // Move #root back to desktop panel if it was relocated.
      var desktopInner = document.getElementById("pn-stage-inner");
      if (desktopInner && mRoot && desktopInner !== mRoot.parentNode) {
        desktopInner.appendChild(mRoot);
      }
    }
  });

})();
</script>

</body>
</html>
