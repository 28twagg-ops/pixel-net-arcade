<!--
Theme: Sci-Fi / Lunar Defense
Font: 'Courier New', Courier, monospace; 'Monaco', 'Consolas', monospace
Style: Retro arcade lunar defense with a gold lander, neon lasers, and peeking cartoon aliens.
Colors: Background (#000000), Player (#FFD700), Enemies (#00ff00), Lasers (#ff0000), Streak/EMP (#00eaff)
Purpose: AI implementation for themes
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTROTYPE - Lunar Defense</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .hud-text {
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        #score-display { color: #fff; }
        #lives-display { color: #ff5555; text-align: right;}
        #streak-display { color: #00eaff; text-align: left; margin-top: 10px; transition: all 0.2s; }
        #level-display { color: #ffff00; text-align: center; width: 100%; position: absolute; top: 20px;}

        /* Streak Activation Blink */
        .streak-active {
            animation: streak-blink 0.15s infinite alternate;
            color: #ffffff !important;
            text-shadow: 0 0 15px #00eaff, 0 0 30px #ffffff !important;
            transform: scale(1.2);
        }

        @keyframes streak-blink {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }

        #menu-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 20, 40, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(8px);
            pointer-events: auto;
            overflow: hidden;
        }

        .title-container {
            text-align: center;
            margin-bottom: 30px;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        h1 {
            font-size: 90px;
            margin: 0;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 15px;
            text-shadow: 
                0px 5px 0px #444, 
                0 0 10px rgba(0, 234, 255, 0.8),
                0 0 30px rgba(0, 234, 255, 0.3);
            position: relative;
            z-index: 20;
        }

        .subtitle {
            font-size: 14px;
            color: #00eaff;
            letter-spacing: 4px;
            margin-top: -10px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 234, 255, 0.3);
            border-radius: 8px;
            padding: 20px 40px;
            margin-bottom: 30px;
            max-width: 500px;
            text-align: center;
        }

        p {
            font-size: 16px;
            color: #ccc;
            margin: 10px 0;
            line-height: 1.6;
        }

        .high-score {
            font-size: 18px;
            color: #ffff00;
            margin-bottom: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        button.main-btn {
            background: #00eaff;
            color: #000;
            border: none;
            padding: 18px 60px;
            font-size: 24px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 6px 0 #0088aa;
            transition: all 0.1s;
            position: relative;
            z-index: 20;
        }

        button.main-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #0088aa;
        }

        button.main-btn:hover {
            background: #fff;
            box-shadow: 0 6px 0 #888;
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .alien-peeker {
            position: absolute;
            bottom: -200px;
            width: 250px;
            height: 250px;
            transition: bottom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 15;
            pointer-events: none;
        }

        .alien-left { left: -50px; transform: rotate(15deg); }
        .alien-right { right: -50px; transform: rotate(-15deg); }

        #game-over-screen:not(.hidden) .alien-peeker { bottom: -40px; }

        .alien-eye { animation: blink 3s infinite; }
        @keyframes blink {
            0%, 96%, 100% { transform: scaleY(1); }
            98% { transform: scaleY(0.1); }
        }

        #bonus-msg {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 40%;
            font-size: 40px;
            color: #00eaff;
            font-weight: bold;
            text-shadow: 0 0 20px #00eaff;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 30;
        }

        #bonus-msg.show {
            opacity: 1;
            transform: scale(1.2);
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div style="display: flex; justify-content: space-between; width: 100%;">
            <div>
                <div id="score-display" class="hud-text">SCORE: 0</div>
                <div id="streak-display" class="hud-text">STREAK: 0/5</div>
            </div>
            <div id="lives-display" class="hud-text">SHIELDS: 100%</div>
        </div>
        <div id="level-display" class="hud-text">WAVE 1</div>
        <div id="bonus-msg">STREAK ZAP! +50</div>
    </div>

    <!-- Starting Page / Menu Screen -->
    <div id="menu-screen">
        <div class="title-container">
            <h1>ASTROTYPE</h1>
            <div class="subtitle">Lunar Defense Initiative</div>
        </div>

        <div class="info-panel">
            <div class="high-score" id="menu-high-score">HIGH SCORE: 0</div>
            <p>Alien decryption codes are falling from orbit.</p>
            <p><strong>MISSION:</strong> Type the codes precisely to neutralize UFOs before they breach lunar soil.</p>
            <p style="color: #00eaff;"><strong>PRO-TIP:</strong> 5 perfect decryptions in a row triggers a high-powered <strong>STREAK ZAP</strong>.</p>
        </div>

        <button class="main-btn" id="start-btn">INITIATE DEFENSE</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="hidden">
        <div class="alien-peeker alien-left">
            <svg viewBox="0 0 200 200">
                <path d="M50,200 Q40,50 100,50 Q160,50 150,200 Z" fill="#44ff44" stroke="#228822" stroke-width="4"/>
                <g class="alien-eye" style="transform-origin: 100px 100px;">
                    <circle cx="80" cy="100" r="20" fill="white" stroke="#228822" stroke-width="2"/>
                    <circle cx="80" cy="100" r="8" fill="black"/><circle cx="120" cy="100" r="20" fill="white" stroke="#228822" stroke-width="2"/>
                    <circle cx="120" cy="100" r="8" fill="black"/><circle cx="100" cy="70" r="15" fill="white" stroke="#228822" stroke-width="2"/>
                    <circle cx="100" cy="70" r="6" fill="black"/>
                </g>
                <path d="M85,140 Q100,150 115,140" fill="none" stroke="#228822" stroke-width="3" stroke-linecap="round"/>
                <ellipse cx="40" cy="180" rx="15" ry="10" fill="#44ff44" stroke="#228822" stroke-width="2"/>
                <ellipse cx="160" cy="180" rx="15" ry="10" fill="#44ff44" stroke="#228822" stroke-width="2"/>
            </svg>
        </div>

        <div class="alien-peeker alien-right">
            <svg viewBox="0 0 200 200">
                 <path d="M50,200 Q40,40 100,40 Q160,40 150,200 Z" fill="#44ff44" stroke="#228822" stroke-width="4"/>
                 <g class="alien-eye" style="transform-origin: 100px 90px;">
                     <circle cx="100" cy="90" r="35" fill="white" stroke="#228822" stroke-width="2"/>
                     <circle cx="100" cy="90" r="12" fill="black"/><circle cx="110" cy="80" r="5" fill="white" opacity="0.5"/>
                 </g>
                 <path d="M80,150 Q100,130 120,150" fill="none" stroke="#228822" stroke-width="3" stroke-linecap="round"/>
                 <ellipse cx="40" cy="180" rx="15" ry="10" fill="#44ff44" stroke="#228822" stroke-width="2"/>
                 <ellipse cx="160" cy="180" rx="15" ry="10" fill="#44ff44" stroke="#228822" stroke-width="2"/>
                 <path d="M100,40 L100,10" stroke="#44ff44" stroke-width="4"/><circle cx="100" cy="10" r="5" fill="#ff0055"/>
            </svg>
        </div>

        <h1 style="color: #44ff44; text-shadow: 0 0 10px #44ff44;">CAPTURED!</h1>
        <p>The lunar perimeter has been breached.<br>The aliens are celebrating your capture!<br><br>Final Score: <span id="final-score" style="color: #fff; font-weight: bold;">0</span></p>
        <button class="main-btn" id="restart-btn">REBOOT SYSTEM</button>
    </div>
</div>

<script>
    const WORD_LIST = [
        "ALIEN", "UFO", "LUNAR", "MOON", "ORBIT", "SPACE", "NASA", "APOLLO", "CRATER", "DUST",
        "VOID", "STAR", "COMET", "MARS", "VENUS", "PLUTO", "EARTH", "SOLAR", "GALAXY", "NEBULA",
        "ROCKET", "PROBE", "ROVER", "LANDER", "MODULE", "DOCK", "HATCH", "SUIT", "OXYGEN", "FUEL",
        "ZERO", "GRAVITY", "LIGHT", "SPEED", "WARP", "HYPER", "LASER", "BEAM", "PLASMA", "SHIELD",
        "RADAR", "SONAR", "SCAN", "DATA", "SIGNAL", "RADIO", "CODE", "CIPHER", "KEY", "LOCK",
        "ALPHA", "BRAVO", "CHARLIE", "DELTA", "ECHO", "FOX", "GOLF", "HOTEL", "INDIA", "JULIET",
        "KILO", "LIMA", "MIKE", "NOV", "OSCAR", "PAPA", "QUEBEC", "ROMEO", "SIERRA", "TANGO",
        "UNIFORM", "VICTOR", "WHISKEY", "XRAY", "YANKEE", "ZULU", "VORTEX", "QUASAR", "PULSAR"
    ];

    const COLORS = {
        bg: '#000000', landerMain: '#FFD700', landerLegs: '#888888', laser: '#ff0000',
        text: '#ffffff', matched: '#44ff44', highlight: '#ff0000', ufo: '#00ff00',
        ufoDome: '#aaffaa', moon: '#222222', moonHighlight: '#333333', emp: '#00eaff'
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let stars = [];
    let moonSurface = [];
    let highScore = localStorage.getItem('astrotype_high_score') || 0;
    
    let state = {
        screen: 'MENU', score: 0, lives: 3, streak: 0, currentWordPerfect: true,
        level: 1, words: [], particles: [], lasers: [], targetIndex: -1,
        spawnTimer: 0, spawnRate: 120, wordSpeed: 0.5, shake: 0, empEffect: 0,
        landerGlow: 0
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        initBackground();
    }
    window.addEventListener('resize', resize);

    function initBackground() {
        stars = [];
        for(let i=0; i<150; i++) {
            stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 });
        }
        moonSurface = [];
        let h = canvas.height - 50;
        let segments = 20;
        let step = canvas.width / segments;
        moonSurface.push({x: 0, y: h});
        for(let i=1; i<=segments; i++) {
            moonSurface.push({ x: i * step, y: h - (Math.random() * 40 - 20) });
        }
        moonSurface.push({x: canvas.width, y: canvas.height}, {x: 0, y: canvas.height});
    }

    // Initialize High Score on Menu
    document.getElementById('menu-high-score').innerText = `HIGH SCORE: ${highScore}`;

    resize();

    class WordEnemy {
        constructor() {
            this.text = WORD_LIST[Math.floor(Math.random() * WORD_LIST.length)];
            this.x = Math.random() * (canvas.width - 150) + 75;
            this.y = -60;
            this.matchedIndex = 0; 
            this.wobble = Math.random() * Math.PI * 2;
        }
        update() {
            this.y += state.wordSpeed;
            this.wobble += 0.05;
        }
        draw(ctx, isTarget) {
            ctx.font = "bold 20px 'Courier New', monospace";
            const textWidth = ctx.measureText(this.text).width;
            const wobbleY = Math.sin(this.wobble) * 5;
            const ufoX = this.x;
            const ufoY = this.y - 15 + wobbleY;
            
            ctx.fillStyle = COLORS.ufoDome;
            ctx.beginPath(); ctx.arc(ufoX, ufoY - 5, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = isTarget ? COLORS.highlight : COLORS.ufo;
            ctx.beginPath(); ctx.ellipse(ufoX, ufoY, 30, 10, 0, 0, Math.PI * 2); ctx.fill();

            if (isTarget) {
                ctx.strokeStyle = COLORS.highlight; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.arc(ufoX, ufoY, 40, 0, Math.PI * 2); ctx.stroke();
            }

            const startX = this.x - textWidth / 2;
            const textY = ufoY + 30;
            ctx.fillStyle = COLORS.matched; ctx.fillText(this.text.substring(0, this.matchedIndex), startX, textY);
            const matchedWidth = ctx.measureText(this.text.substring(0, this.matchedIndex)).width;
            ctx.fillStyle = isTarget ? COLORS.highlight : COLORS.text;
            ctx.fillText(this.text.substring(this.matchedIndex), startX + matchedWidth, textY);
        }
        isFinished() { return this.matchedIndex >= this.text.length; }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 4 + 1;
            this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
            this.life = 1.0; this.decay = Math.random() * 0.03 + 0.02;
            this.color = color || '#fff'; this.size = Math.random() * 3 + 1;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; }
        draw(ctx) { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.globalAlpha = 1.0; }
    }

    class Laser {
        constructor(tx, ty, isEmp) {
            this.sx = canvas.width / 2; this.sy = canvas.height - 90;
            this.tx = tx; this.ty = ty; this.life = isEmp ? 20 : 8; 
            this.isEmp = isEmp;
        }
        draw(ctx) {
            if (this.life <= 0) return;
            ctx.beginPath(); ctx.moveTo(this.sx, this.sy); ctx.lineTo(this.tx, this.ty);
            ctx.strokeStyle = this.isEmp ? `rgba(0, 234, 255, ${this.life/20})` : `rgba(255, 0, 0, ${this.life/8})`; 
            ctx.lineWidth = this.isEmp ? 10 : 2; 
            ctx.stroke();
            this.life--;
        }
    }

    window.addEventListener('keydown', (e) => {
        if (state.screen !== 'PLAYING') return;
        const key = e.key.toUpperCase();
        if (/^[A-Z]$/.test(key)) handleInput(key);
    });

    function handleInput(char) {
        if (state.targetIndex !== -1) {
            const target = state.words[state.targetIndex];
            if (!target) { state.targetIndex = -1; handleInput(char); return; }

            if (char === target.text[target.matchedIndex]) {
                target.matchedIndex++;
                createLaser(target.x, target.y);
                if (target.isFinished()) {
                    const wasPerfect = state.currentWordPerfect;
                    const savedIndex = state.targetIndex;
                    const wordLength = target.text.length;

                    destroyWord(savedIndex);
                    state.targetIndex = -1;

                    if (wasPerfect) {
                        state.streak++;
                    } else {
                        state.streak = 0;
                    }
                    
                    if (state.streak >= 5) {
                        triggerStreakZap();
                    }

                    state.score += 10 + (wordLength * 2);
                    checkLevelUp();
                }
            } else {
                state.shake = 5; 
                state.streak = 0;
                state.currentWordPerfect = false;
            }
        } else {
            let bestIndex = -1; let maxY = -1000;
            for (let i = 0; i < state.words.length; i++) {
                if (state.words[i].text.startsWith(char) && state.words[i].y > maxY) {
                    maxY = state.words[i].y; bestIndex = i;
                }
            }
            if (bestIndex !== -1) {
                state.targetIndex = bestIndex;
                state.currentWordPerfect = true;
                handleInput(char);
            }
        }
        updateHUD();
    }

    function triggerStreakZap() {
        state.streak = 0;
        let lowestIndex = -1;
        let maxY = -1000;
        for (let i = 0; i < state.words.length; i++) {
            if (state.words[i].y > maxY) {
                maxY = state.words[i].y;
                lowestIndex = i;
            }
        }

        if (lowestIndex !== -1) {
            const target = state.words[lowestIndex];
            state.empEffect = 0.1; 
            state.shake = 25;
            state.score += 75; 
            state.landerGlow = 30; 
            
            state.lasers.push(new Laser(target.x, target.y, true));
            
            const msg = document.getElementById('bonus-msg');
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 1500);

            const streakHUD = document.getElementById('streak-display');
            streakHUD.classList.add('streak-active');
            setTimeout(() => streakHUD.classList.remove('streak-active'), 800);

            destroyWord(lowestIndex);
        } else {
            state.score += 150;
        }
        updateHUD();
    }

    function initGame() {
        state = { ...state, screen: 'PLAYING', score: 0, lives: 3, streak: 0, level: 1, words: [], particles: [], lasers: [], targetIndex: -1, spawnTimer: 0, spawnRate: 120, wordSpeed: 0.4, shake: 0, empEffect: 0, landerGlow: 0 };
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        updateHUD();
        loop();
    }

    function destroyWord(index) {
        if (index < 0 || index >= state.words.length) return;
        const w = state.words[index];
        if (!w) return;
        for(let i=0; i<15; i++) state.particles.push(new Particle(w.x, w.y, COLORS.ufo));
        state.words.splice(index, 1);
        if (state.targetIndex === index) {
            state.targetIndex = -1;
        } else if (state.targetIndex > index) {
            state.targetIndex--;
        }
    }

    function createLaser(x, y) { state.lasers.push(new Laser(x, y, false)); }

    function checkLevelUp() {
        const newLevel = Math.floor(state.score / 250) + 1;
        if (newLevel > state.level) {
            state.level = newLevel;
            state.spawnRate = Math.max(40, 120 - (state.level * 8));
            state.wordSpeed = 0.4 + (state.level * 0.1);
            document.getElementById('level-display').innerText = `WAVE ${state.level}`;
        }
    }

    function updateHUD() {
        document.getElementById('score-display').innerText = `SCORE: ${state.score}`;
        const streakEl = document.getElementById('streak-display');
        streakEl.innerText = `STREAK: ${state.streak}/5`;
        if (state.streak >= 4) streakEl.style.color = "#ffff00";
        else streakEl.style.color = "#00eaff";
        let shields = Math.max(0, Math.round((state.lives/3)*100));
        document.getElementById('lives-display').innerText = `SHIELDS: ${shields}%`;
        document.getElementById('lives-display').style.color = shields < 40 ? '#ff0000' : '#44ff44';
    }

    function gameOver() {
        state.screen = 'GAMEOVER';
        // Save high score
        if (state.score > highScore) {
            highScore = state.score;
            localStorage.setItem('astrotype_high_score', highScore);
            document.getElementById('menu-high-score').innerText = `HIGH SCORE: ${highScore}`;
        }
        document.getElementById('final-score').innerText = state.score;
        document.getElementById('game-over-screen').classList.remove('hidden');
    }

    function drawBackground() {
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            ctx.globalAlpha = 0.3 + Math.sin(Date.now() * 0.002 + s.x) * 0.7;
            ctx.fillRect(s.x, s.y, s.size, s.size);
        });
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = COLORS.moon;
        ctx.beginPath();
        ctx.moveTo(moonSurface[0].x, moonSurface[0].y);
        for(let i=1; i<moonSurface.length; i++) ctx.lineTo(moonSurface[i].x, moonSurface[i].y);
        ctx.fill();
    }

    function drawLander() {
        const cx = canvas.width / 2, cy = canvas.height - 40;
        if (state.landerGlow > 0) {
            ctx.shadowBlur = state.landerGlow;
            ctx.shadowColor = COLORS.emp;
            state.landerGlow--;
        } else {
            ctx.shadowBlur = 0;
        }
        ctx.strokeStyle = COLORS.landerLegs; ctx.lineWidth = 3; ctx.beginPath();
        ctx.moveTo(cx - 20, cy - 20); ctx.lineTo(cx - 35, cy + 10); ctx.lineTo(cx - 45, cy + 10);
        ctx.moveTo(cx + 20, cy - 20); ctx.lineTo(cx + 35, cy + 10); ctx.lineTo(cx + 45, cy + 10); ctx.stroke();
        ctx.fillStyle = state.landerGlow % 4 < 2 && state.landerGlow > 0 ? '#fff' : COLORS.landerMain; 
        ctx.beginPath();
        ctx.moveTo(cx - 25, cy - 20); ctx.lineTo(cx + 25, cy - 20); ctx.lineTo(cx + 30, cy - 40); ctx.lineTo(cx + 20, cy - 60); ctx.lineTo(cx - 20, cy - 60); ctx.lineTo(cx - 30, cy - 40); ctx.fill();
        ctx.shadowBlur = 0;
    }

    function loop() {
        if (state.screen !== 'PLAYING') return;
        ctx.fillStyle = COLORS.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (state.shake > 0) {
            ctx.save(); ctx.translate((Math.random()-0.5)*state.shake, (Math.random()-0.5)*state.shake);
            state.shake *= 0.9; if (state.shake < 0.5) state.shake = 0;
        }
        drawBackground();
        drawLander();
        if (state.empEffect > 0) {
            ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height-60, state.empEffect * canvas.width * 1.5, 0, Math.PI*2);
            ctx.strokeStyle = COLORS.emp; ctx.lineWidth = 10; ctx.globalAlpha = 1 - state.empEffect;
            ctx.stroke(); ctx.globalAlpha = 1.0;
            state.empEffect += 0.04;
            if (state.empEffect >= 1) state.empEffect = 0;
        }
        state.spawnTimer++;
        if (state.spawnTimer > state.spawnRate) { state.words.push(new WordEnemy()); state.spawnTimer = 0; }
        for (let i = state.words.length - 1; i >= 0; i--) {
            const w = state.words[i]; w.update(); w.draw(ctx, i === state.targetIndex);
            if (w.y > canvas.height - 60) {
                state.lives--;
                state.streak = 0;
                state.shake = 15; 
                destroyWord(i); 
                updateHUD();
                if (state.lives <= 0) { if (state.shake > 0) ctx.restore(); gameOver(); return; }
            }
        }
        for (let i = state.particles.length - 1; i >= 0; i--) {
            const p = state.particles[i]; p.update(); p.draw(ctx);
            if (p.life <= 0) state.particles.splice(i, 1);
        }
        for (let i = state.lasers.length - 1; i >= 0; i--) {
            const l = state.lasers[i]; l.draw(ctx);
            if (l.life <= 0) state.lasers.splice(i, 1);
        }
        if (state.shake > 0) ctx.restore();
        requestAnimationFrame(loop);
    }

    document.getElementById('start-btn').addEventListener('click', initGame);
    document.getElementById('restart-btn').addEventListener('click', initGame);
</script>
</body>
</html>